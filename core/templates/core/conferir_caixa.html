{% extends 'core/base.html' %}

{% block content %}
<style>
    /* ESTILOS VISUAIS */
    .proc-item { display: flex; justify-content: space-between; align-items: center; font-family: var(--bs-font-monospace); font-size: 1.1rem; }
    
    /* Cores Espec√≠ficas para as Listas */
    .bg-permanente { background-color: #cff4fc; border-color: #b6effb; color: #055160; } /* Azul Claro */
    .bg-normal { background-color: #d1e7dd; border-color: #badbcc; color: #0f5132; } /* Verde Claro */
    .bg-erro { background-color: #f8d7da; border-color: #f5c2c7; color: #842029; } /* Vermelho Claro */

    /* ESTILOS DE IMPRESS√ÉO */
    @media print {
        body * { visibility: hidden; }
        .navbar, .modal, #tela-conferencia, #loading-overlay { display: none !important; }
        #tela-relatorio, #tela-relatorio * { visibility: visible; }
        #tela-relatorio { position: absolute; left: 0; top: 0; width: 100%; display: block !important; border: none !important; }
        .no-print { display: none !important; }
        .card { border: 1px solid #000 !important; margin-bottom: 10px; break-inside: avoid; }
        .badge { border: 1px solid #000; color: #000 !important; background: none !important; }
    }
</style>

<div class="container mt-4">

    <input type="hidden" id="usuario-logado" value="{{ user.get_full_name|default:user.username|upper }}">

    <div id="loading-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.7); z-index:9999; text-align:center; padding-top:20%;">
        <div class="spinner-border text-primary" role="status"></div>
        <h4 class="mt-2">Verificando base de dados...</h4>
    </div>

    <div class="modal fade" id="modalCaixa" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow-lg">
                <div class="modal-header bg-dark text-white justify-content-center">
                    <h4 class="modal-title">Conferir Caixa</h4>
                </div>
                <div class="modal-body p-4 text-center">
                    <label for="input_caixa" class="form-label mb-2 fw-bold fs-5">Qual caixa deseja conferir?</label>
                    <input class="form-control form-control-lg text-center mb-3" list="lista-caixas" id="input_caixa" placeholder="Digite o n¬∫ da Caixa..." autocomplete="off">
                    <datalist id="lista-caixas">{% for caixa in caixas %}<option value="{{ caixa }}">{% endfor %}</datalist>
                    <div class="d-grid">
                        <button id="btn-confirmar-caixa" class="btn btn-primary btn-lg">CONFIRMAR (ENTER)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tela-conferencia" style="display: none;"> <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="m-0">Caixa: <span id="titulo-caixa" class="text-primary fw-bold">---</span></h3>
            <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">Sair / Trocar</button>
        </div>

        <div class="card mb-3 bg-light border-0">
            <div class="card-body p-3">
                <div class="input-group input-group-lg">
                    <input type="text" id="input_processo" class="form-control font-monospace" placeholder="Bipe ou digite o processo" maxlength="25" autocomplete="off">
                    <button id="btn-ok-processo" class="btn btn-success" type="button">OK</button>
                    <button id="btn-finalizar" class="btn btn-dark ms-2 fw-bold" type="button">FINALIZAR CAIXA</button>
                </div>
                <div id="msg-status" class="fw-bold mt-2 text-center" style="min-height: 24px;"></div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4 mb-3"> 
                <div class="card h-100 border-primary">
                    <div class="card-header bg-primary text-white text-center py-1">
                        <strong>üíé PERMANENTES</strong> (<span id="count-perm">0</span>)
                    </div>
                    <div class="card-body p-0" style="height: 400px; overflow-y: auto;">
                        <ul class="list-group list-group-flush" id="lista-permanentes"></ul>
                    </div>
                </div>
            </div>

            <div class="col-md-4 mb-3"> 
                <div class="card h-100 border-success">
                    <div class="card-header bg-success text-white text-center py-1">
                        <strong>LIDOS NA CAIXA</strong> (<span id="count-normal">0</span>)
                    </div>
                    <div class="card-body p-0" style="height: 400px; overflow-y: auto;">
                        <ul class="list-group list-group-flush" id="lista-normal"></ul>
                    </div>
                </div>
            </div>

            <div class="col-md-4 mb-3">
                <div class="card h-100 border-secondary">
                    <div class="card-header bg-secondary text-white text-center py-1">
                        <strong>ESPERADOS NA CAIXA</strong> (<span id="count-banco">0</span>)
                    </div>
                    <div class="card-body p-0" style="height: 400px; overflow-y: auto;">
                        <ul class="list-group list-group-flush" id="lista-direita"><li class="list-group-item text-muted text-center">Carregando...</li></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tela-relatorio" style="display: none;" class="bg-white p-4 border rounded">
        <div class="text-center border-bottom mb-4 pb-2">
            <h2>Relat√≥rio de Confer√™ncia</h2>
            <h4 class="text-muted">Caixa Base: <strong id="relatorio-titulo-caixa" class="text-dark">---</strong></h4>
            <div id="info-auditoria" class="text-secondary small mt-2"></div>
        </div>
        <div id="conteudo-relatorio" class="mb-4"></div>
        <div class="mt-5 text-center no-print">
            <button onclick="window.print()" class="btn btn-primary btn-lg me-3">üñ®Ô∏è IMPRIMIR</button>
            <button onclick="location.reload()" class="btn btn-secondary btn-lg">Nova Confer√™ncia</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Elementos Globais
        const telaConferencia = document.getElementById('tela-conferencia');
        const telaRelatorio = document.getElementById('tela-relatorio');
        
        // Elementos da Modal
        const inputCaixa = document.getElementById('input_caixa');
        const btnConfirmarCaixa = document.getElementById('btn-confirmar-caixa');
        
        // Elementos da Confer√™ncia
        const tituloCaixa = document.getElementById('titulo-caixa');
        const inputProcesso = document.getElementById('input_processo');
        const btnOkProcesso = document.getElementById('btn-ok-processo');
        const btnFinalizar = document.getElementById('btn-finalizar');
        const msgStatus = document.getElementById('msg-status');
        
        // Listas
        const listaPermanentes = document.getElementById('lista-permanentes');
        const listaNormal = document.getElementById('lista-normal');
        const listaDireita = document.getElementById('lista-direita');
        
        const countPerm = document.getElementById('count-perm');
        const countNormal = document.getElementById('count-normal');
        const countBanco = document.getElementById('count-banco');
        
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        // INICIALIZA√á√ÉO DA MODAL
        // Usamos o Bootstrap para controlar a modal
        var modalCaixa = new bootstrap.Modal(document.getElementById('modalCaixa'), {});
        modalCaixa.show();

        // Foca no input da caixa assim que a modal abre
        document.getElementById('modalCaixa').addEventListener('shown.bs.modal', function () {
            inputCaixa.focus();
        });

        // Eventos UX
        inputProcesso.addEventListener('input', function() { this.value = this.value.replace(/\D/g, ''); msgStatus.innerText = ''; });
        
        // Mant√©m foco no input se clicar fora
        telaConferencia.addEventListener('click', function(e) { 
            if(e.target.tagName !== 'BUTTON' && e.target.tagName !== 'A' && e.target.tagName !== 'INPUT') { 
                inputProcesso.focus(); 
            }
        });

        // 1. CONFIRMAR CAIXA
        inputCaixa.addEventListener('keydown', (e) => { if(e.key === 'Enter') confirmingCaixa(); });
        btnConfirmarCaixa.addEventListener('click', confirmingCaixa);

        function confirmingCaixa() {
            const caixa = inputCaixa.value.trim();
            if (!caixa) { alert('Informe a caixa.'); return; }
            
            // Fecha Modal e Mostra Tela
            modalCaixa.hide();
            telaConferencia.style.display = 'block';
            
            tituloCaixa.innerText = caixa; 
            document.getElementById('relatorio-titulo-caixa').innerText = caixa;
            
            if (audioCtx.state === 'suspended') { audioCtx.resume(); }
            carregarListaBanco(caixa); 
            
            // Pequeno delay para garantir que o input esteja vis√≠vel antes de focar
            setTimeout(() => inputProcesso.focus(), 300);
        }

        // 2. PROCESSAR INPUT (BIPAGEM)
        inputProcesso.addEventListener('keydown', (e) => { if(e.key === 'Enter') processarInput(); });
        btnOkProcesso.addEventListener('click', processarInput);

        async function processarInput() {
            let numeroOriginal = inputProcesso.value.trim().replace(/\D/g, ''); 
            if (!numeroOriginal) return;
            let tam = numeroOriginal.length;

            // 4. VALIDA√á√ÉO CORRIGIDA (Sintaxe JavaScript)
            // Se o tamanho for diferente de 10 E diferente de 15...
            if (tam !== 10 && tam !== 15) {
                // Dica: √â bom avisar o usu√°rio por que n√£o funcionou
                tocarSom('erro');
                msgStatus.innerText = `Tamanho inv√°lido (${tam} d√≠gitos). Aceito apenas 10 ou 15.`;
                msgStatus.className = 'text-warning fw-bold mt-2 text-center';
                inputProcesso.value = ''; 
                inputProcesso.focus();
                return; // Para a execu√ß√£o aqui
            }
            // Tratamento de ano 98/99
            let numeroProcessado = numeroOriginal;
            if (numeroOriginal.startsWith('9819') && numeroOriginal.length > 2) numeroProcessado = '199871100' + numeroOriginal.substring(4);
            else if (numeroOriginal.startsWith('9919') && numeroOriginal.length > 2) numeroProcessado = '199971100' + numeroOriginal.substring(4);

            // Verifica duplicidade visual
            if (verificarDuplicidadeVisual(numeroProcessado)) {
                tocarSom('erro');
                msgStatus.innerText = `Processo ${numeroProcessado} j√° foi lido!`;
                msgStatus.className = 'text-warning fw-bold mt-2 text-center';
                inputProcesso.value = ''; inputProcesso.focus(); 
                return;
            }

            // CONSULTA AO SERVIDOR
            try {
                // console.log("Consultando:", numeroProcessado);
                const response = await fetch(`/ajax/checar-processo/?numero=${numeroProcessado}`);
                const dados = await response.json();
                registrarProcesso(numeroProcessado, dados);
            } catch (error) {
                console.error("Erro na busca:", error);
                registrarProcessoOffline(numeroProcessado);
            }
        }

        function registrarProcesso(numero, dadosServidor) {
            const estavaNaLista = removerDosPendentes(numero);
            const li = document.createElement('li');
            li.className = 'list-group-item proc-item animate__animated animate__fadeIn';

            let textoSituacao = dadosServidor.situacao || "---";
            let origem = dadosServidor.caixa_origem || "Desconhecida";

            let conteudoHTML = `
                <div class="w-100">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-bold fs-5">${numero}</span>
                        VAR_BADGE
                    </div>
                             </div>
            `;

      
            if (dadosServidor.encontrado && dadosServidor.is_permanente) {
                tocarSom('permanente');
                msgStatus.innerText = `‚ö†Ô∏è PERMANENTE DETECTADO!`;
                msgStatus.className = 'text-primary fw-bold mt-2 text-center';
                
                li.classList.add('list-group-item-info');
                li.innerHTML = conteudoHTML.replace('VAR_BADGE', '<span class="badge bg-primary">PERMANENTE</span>');
                li.dataset.tipo = 'permanente';
                li.dataset.origem = origem;
                
                listaPermanentes.insertBefore(li, listaPermanentes.firstChild);
                countPerm.innerText = parseInt(countPerm.innerText) + 1;
            } 
            else if (estavaNaLista) {
                tocarSom('sucesso');
                msgStatus.innerText = "Processo OK";
                msgStatus.className = 'text-success fw-bold mt-2 text-center';
                
                li.innerHTML = conteudoHTML.replace('VAR_BADGE', '<span class="badge bg-success">OK</span>');
                li.dataset.tipo = 'normal';
                
                listaNormal.insertBefore(li, listaNormal.firstChild);
                countNormal.innerText = parseInt(countNormal.innerText) + 1;
            }
            else if (dadosServidor.encontrado) {
                tocarSom('erro');
                msgStatus.innerText = `Localizador errado! Pertence √† caixa: ${origem}`;
                msgStatus.className = 'text-danger fw-bold mt-2 text-center';
                
                li.classList.add('list-group-item-warning');
                li.innerHTML = conteudoHTML.replace('VAR_BADGE', '<span class="badge bg-warning text-dark">NOVO</span>');
                li.dataset.tipo = 'erro';
                li.dataset.origem = origem;
                
                listaNormal.insertBefore(li, listaNormal.firstChild);
            }
            else {
                tocarSom('erro');
                msgStatus.innerText = "N√£o consta no banco de dados!";
                msgStatus.className = 'text-danger fw-bold mt-2 text-center';
                
                li.classList.add('list-group-item-danger');
                li.innerHTML = `
                    <div class="w-100">
                        <span class="fw-bold fs-5">${numero}</span> 
                        <span class="badge bg-danger float-end">N√ÉO CADASTRADO</span>
                    </div>`;
                li.dataset.tipo = 'erro';
                
                listaNormal.insertBefore(li, listaNormal.firstChild);
            }
            inputProcesso.value = ''; inputProcesso.focus();
        }
        
        function registrarProcessoOffline(numero) {
            const achou = removerDosPendentes(numero);
            const li = document.createElement('li');
            li.className = 'list-group-item proc-item animate__animated animate__fadeIn';
            if (achou) {
                tocarSom('sucesso');
                li.innerHTML = `<span class="fw-bold">${numero}</span> <span class="badge bg-secondary">OFFLINE</span>`;
                listaNormal.insertBefore(li, listaNormal.firstChild);
                countNormal.innerText = parseInt(countNormal.innerText) + 1;
            } else {
                tocarSom('erro');
                li.innerHTML = `<span class="fw-bold">${numero}</span> <span class="badge bg-danger">NOVO</span>`;
                li.classList.add('list-group-item-danger');
                listaNormal.insertBefore(li, listaNormal.firstChild);
            }
            inputProcesso.value = ''; inputProcesso.focus();
        }

        function removerDosPendentes(numero) {
            let item = document.getElementById('banco-' + numero);
            if (!item) {
                const raizInput = numero.slice(0, -1);
                const listaItens = listaDireita.getElementsByTagName('li');
                for (let li of listaItens) {
                    const numBanco = li.dataset.numero; 
                    if (numBanco && numBanco.slice(0, -1) === raizInput) { 
                        item = li; break; 
                    }
                }
            }
            if (item) {
                item.remove();
                countBanco.innerText = Math.max(0, parseInt(countBanco.innerText) - 1);
                return true;
            }
            return false;
        }

        function verificarDuplicidadeVisual(numero) {
            const listas = [listaPermanentes, listaNormal];
            for (let lista of listas) {
                const itens = lista.querySelectorAll('li span.fw-bold');
                for (let span of itens) {
                    if (span.innerText === numero) return true;
                }
            }
            return false;
        }

        function tocarSom(tipo) {
            try {
                const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
                o.connect(g); g.connect(audioCtx.destination);
                if (tipo === 'permanente') {
                    o.type = 'square'; o.frequency.value = 800; g.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    o.start(); o.stop(audioCtx.currentTime + 0.1);
                    setTimeout(() => {
                        const o2 = audioCtx.createOscillator(); const g2 = audioCtx.createGain();
                        o2.connect(g2); g2.connect(audioCtx.destination);
                        o2.type = 'square'; o2.frequency.value = 800; g2.gain.value = 0.1;
                        o2.start(); o2.stop(audioCtx.currentTime + 0.1);
                    }, 150);
                } else if (tipo === 'sucesso') {
                    o.type = 'sine'; o.frequency.value = 400; g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2); o.start(); o.stop(audioCtx.currentTime + 0.2);
                } else {
                    o.type = 'sawtooth'; o.frequency.value = 150; g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3); o.start(); o.stop(audioCtx.currentTime + 0.3);
                }
            } catch(e){}
        }

        function carregarListaBanco(caixa) {
            fetch(`/ajax/get-processos/?caixa=${encodeURIComponent(caixa)}`)
                .then(res => res.json())
                .then(data => {
                    listaDireita.innerHTML = ''; countBanco.innerText = data.processos.length;
                    if (data.processos.length === 0) { listaDireita.innerHTML = '<li class="list-group-item text-danger">Caixa vazia.</li>'; return; }
                    data.processos.forEach(proc => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item'; 
                        li.id = 'banco-' + proc.numero; 
                        li.dataset.numero = proc.numero; 
                        li.innerText = proc.numero; 
                        listaDireita.appendChild(li);
                    });
                });
        }
        
        // --- RELAT√ìRIO FINAL ---
        btnFinalizar.addEventListener('click', function() {
            const usuario = document.getElementById('usuario-logado').value;
            const hoje = new Date().toLocaleString('pt-BR');
            document.getElementById('info-auditoria').innerHTML = `Respons√°vel: <strong>${usuario}</strong><br>Data: ${hoje}`;
            
            let html = '';

            // 1. Permanentes
            const perms = listaPermanentes.querySelectorAll('li');
            if (perms.length > 0) {
                html += `<div class="card border-primary mb-4"><div class="card-header bg-primary text-white fw-bold text-center">üíé PROCESSOS PERMANENTES ENCONTRADOS - Separar(${perms.length})</div><ul class="list-group list-group-flush text-center font-monospace">`;
                perms.forEach(li => {
                    const num = li.querySelector('span.fw-bold').innerText;
                    const origem = li.dataset.origem || 'Desconhecida';
                    // CORRE√á√ÉO: O HTML estava incompleto e com colchete perdido aqui
                    html += `<li class="list-group-item list-group-item-info"><strong>${num}</strong> <small class="text-muted"> -> Caixa de Origem: ${origem}</small></li>`;
                });
                html += `</ul></div>`;
            }

            // 2. Normais
            const normals = listaNormal.querySelectorAll('li[data-tipo="normal"]');
            if (normals.length > 0) {
                html += `<div class="card border-success mb-4"><div class="card-header bg-success text-white fw-bold text-center">‚úÖ PROCESSOS CORRETAMENTE NA CAIXA (${normals.length})</div><ul class="list-group list-group-flush text-center font-monospace" style="column-count: 2;">`;
                normals.forEach(li => html += `<li class="list-group-item py-1">${li.querySelector('span.fw-bold').innerText}</li>`);
                html += `</ul></div>`;
            }

            // 3. Erros
            const erros = listaNormal.querySelectorAll('li[data-tipo="erro"]');
            if (erros.length > 0) {
                html += `<div class="card border-danger mb-4"><div class="card-header bg-danger text-white fw-bold text-center">‚ö†Ô∏è PROCESSOS EXCEDENTES - cadastrar na caixa (${erros.length})</div><ul class="list-group list-group-flush text-center font-monospace">`;
                
                erros.forEach(li => {
                    // Extra√ß√£o de vari√°veis igual ao modelo
                    const num = li.querySelector('span.fw-bold').innerText;
                    const origem = li.dataset.origem || 'Desconhecida';
                    // Montagem do HTML mantendo o estilo de erro (vermelho)
                    html += `<li class="list-group-item list-group-item-danger"><strong>${num}</strong> <small class="text-muted"> -> Caixa de Origem: ${origem}</small></li>`;
                });
                html += `</ul></div>`;
            }

            // 4. Faltantes
            const faltantes = listaDireita.querySelectorAll('li');
            if (faltantes.length > 0 && faltantes[0].innerText !== "Carregando...") {
                html += `<div class="card border-secondary mb-4"><div class="card-header bg-secondary text-white fw-bold text-center">‚ùå PROCESSOS N√ÉO ENCONTRADOS CAIXA - transferir localizador (${faltantes.length})</div><ul class="list-group list-group-flush text-center font-monospace" style="column-count: 2;">`;
                faltantes.forEach(li => html += `<li class="list-group-item py-1">${li.innerText}</li>`);
                html += `</ul></div>`;
            }

            document.getElementById('conteudo-relatorio').innerHTML = html;
            
            // Fecha a tela de confer√™ncia e abre relat√≥rio
            telaConferencia.style.display = 'none';
            telaRelatorio.style.display = 'block';
        });
    });
</script>
{% endblock %}